<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Enervi7 v7.0 Core + Journey/Oracle/Oils</title>
  <meta name="theme-color" content="#6d28d9" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon-192.png" />
  <style>
    /* ====== Core minimal styles（保留你原本的風格可再疊加） ====== */
    :root{--bg:#0f0f1a;--card:#161628;--text:#f3f3ff;--muted:#b9b9d6;--brand:#7c3aed;--brand2:#8b5cf6;--ok:#22c55e;--warn:#f59e0b}
    html,body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Inter,Helvetica,Arial,sans-serif;margin:0}
    .container{max-width:960px;margin:0 auto;padding:16px 16px 64px}
    header{padding:24px 16px 8px;background:linear-gradient(180deg,#6d28d9 0%,#4c1d95 100%)}
    header h1{margin:0;font-size:28px}
    header .sub{opacity:.9;margin-top:6px;font-size:14px}
    .section{background:var(--card);border-radius:16px;padding:16px;margin:16px 0;border:1px solid rgba(255,255,255,.07)}
    h2{margin:0 0 12px;font-size:20px}
    .small{opacity:.85;font-size:13px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .btn{background:var(--brand);border:none;color:#fff;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    .btn.secondary{background:#2a2a44}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#262645;font-size:12px}
    .ok{color:#10b981}.warn{color:#f59e0b}.muted{color:var(--muted)}
    input[type=range]{width:100%}
    .q{background:#101025;border:1px solid #252545;border-radius:12px;padding:12px;margin:10px 0}
    /* radar svg sizing */
    #radar{width:100%;height:auto;display:block}
    .kvs{display:flex;gap:6px;flex-wrap:wrap}
    .kv{background:#232347;border:1px solid #31315b;border-radius:8px;padding:4px 8px;font-size:12px}
    .badge-row{display:flex;gap:12px;margin-top:8px}
    .badge{width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#232347;border:1px solid #2f2f55;position:relative;overflow:hidden}
    .badge img{width:100%;height:100%;object-fit:cover}
    .badge.lock::after{content:"🔒";position:absolute;font-size:18px}
    .progress{height:10px;background:#232347;border:1px solid #303055;border-radius:999px;overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,var(--brand),var(--brand2))}
    .card{background:#121228;border:1px solid #26264d;padding:12px;border-radius:12px}
    details>summary{cursor:pointer;list-style:none}
    details>summary::-webkit-details-marker{display:none}
    .footer{opacity:.55;text-align:center;margin-top:18px}
  </style>
  <!-- 額外樣式（若 assets/extras.css 存在會覆蓋強化） -->
  <link rel="stylesheet" href="assets/extras.css" onerror="this.remove()">
</head>
<body>
<header>
  <div class="container">
    <h1>Enervi7 v7.0 Core</h1>
    <div class="sub">本版本：14 題量表 + SVG 雷達 + 七階資訊卡 ＋ 旅程進度 / 呢喃神諭 / 今日建議精油（離線可用，不依賴外部 CDN）</div>
  </div>
</header>

<main class="container">

  <!-- 旅程進度（新增模組） -->
  <section class="section">
    <h2>🌀 旅程進度</h2>
    <div id="journey-card"></div>
  </section>

  <!-- 14 題量表 -->
  <section class="section">
    <h2>🧭 14 題量表（0–10）</h2>
    <div class="small">0＝完全不符合／幾乎沒有　｜　10＝非常符合／幾乎總是</div>
    <div id="qs"></div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="genRadar">生成能量圖</button>
      <div class="small">目前平均分會反映到下方資訊卡與雷達圖。</div>
    </div>
  </section>

  <!-- 雷達圖 -->
  <section class="section">
    <h2>📈 能量雷達圖</h2>
    <svg id="radar" viewBox="0 0 420 420" aria-label="能量雷達圖"></svg>
    <div id="scoresLine" class="small" style="margin-top:8px"></div>
  </section>

  <!-- 呢喃神諭（新增模組） -->
  <section class="section">
    <h2>🏮 呢喃神諭（Whispering Oracle）</h2>
    <div id="oracleBox" class="oracle card"></div>
    <div class="row" style="margin-top:8px">
      <button id="drawOracle" class="btn secondary">抽一張</button>
      <div class="small">同一天僅顯示一張；隔天自動刷新。</div>
    </div>
  </section>

  <!-- 今日建議精油（新增模組） -->
  <section class="section">
    <h2>🪔 今日建議精油</h2>
    <div id="oilBox" class="small">請先完成量表並生成雷達圖；系統會根據最低兩階段挑出 2–3 款建議精油。</div>
    <div class="row" style="margin-top:8px">
      <button id="swapOil" class="btn secondary">換一款（示意）</button>
      <span class="small">顯示：英文名稱（官方中文）＋能量描述。</span>
    </div>
  </section>

  <!-- 七階資訊卡（自動展開最低兩階） -->
  <section class="section">
    <h2>🌈 七階資訊卡（自動展開最低兩階）</h2>
    <div id="infoCards"></div>
  </section>

  <div class="footer small">Made with 💜 Enervi7</div>
</main>

<script>
/* =========================
   v7.0 Core：題目＋雷達＋資訊卡
   ========================= */
const STAGES = [
  { key:'白', name:'能量覺知' },
  { key:'藍', name:'穩定與淨化' },
  { key:'橙', name:'能量流動' },
  { key:'黃', name:'內在力量' },
  { key:'綠', name:'共振與連結' },
  { key:'靛藍', name:'意識擴展' },
  { key:'紫', name:'靈魂整合' },
];

const QUESTIONS = [
  // ① 白
  '我能清楚覺察自己此刻的身心狀態。','我能在混亂時，迅速把注意力帶回當下。',
  // ② 藍
  '面對壓力或衝突時，我能保持冷靜不失衡。','我能有效地釋放累積的負面情緒與雜念。',
  // ③ 橙
  '我常感覺靈感／情感在體內自然流動。','我能順勢調整步調，不僵硬或卡住。',
  // ④ 黃
  '做決定時，我能堅定地選擇對自己真的好的事。','遇到挑戰，我仍能相信自己並往前一步。',
  // ⑤ 綠
  '我能真誠表達，也樂於傾聽他人。','我能感到自己與他人、與世界是連結的。',
  // ⑥ 靛藍
  '我信任直覺，且能從中獲得有用的指引。','我能從日常事件看見更深的洞見與意義。',
  // ⑦ 紫
  '我能把過去的經驗整合成力量，而不是枷鎖。','我常感到自己完整、對生命方向踏實安心。'
];
// 14 題：每兩題對應一階
const sliders = [];
const qsBox = document.getElementById('qs');
for(let i=0;i<14;i++){
  const stageIndex = Math.floor(i/2); // 0..6
  const wrap = document.createElement('div'); wrap.className='q';
  wrap.innerHTML = `
    <div><b>${stageIndex+1}. ${STAGES[stageIndex].key}｜${STAGES[stageIndex].name}</b>｜${QUESTIONS[i]}</div>
    <input type="range" min="0" max="10" step="1" value="5" id="q${i}">
    <div class="small">目前：<span id="qv${i}">5</span> / 10</div>
  `;
  qsBox.appendChild(wrap);
  const input = wrap.querySelector('input');
  const vspan = wrap.querySelector(`#qv${i}`);
  input.addEventListener('input', ()=> vspan.textContent=input.value);
  sliders.push(input);
}

function computeStageAverages(){
  const avgs = Array(7).fill(0);
  for(let s=0;s<7;s++){
    const a = Number(sliders[s*2].value);
    const b = Number(sliders[s*2+1].value);
    avgs[s] = (a+b)/2;
  }
  return avgs;
}

/* ===== Radar SVG（純前端、不依賴外部 CDN） ===== */
const radarSVG = document.getElementById('radar');
const scoresLine = document.getElementById('scoresLine');
function drawRadar(values){ // [7] 0..10
  const W=420,H=420,CX=W/2,CY=H/2,R=160, LV=5; // 5 rings
  const N=7, angStep = (Math.PI*2)/N;
  radarSVG.innerHTML='';
  // rings + spokes
  for(let l=1;l<=LV;l++){
    const r=R*l/LV;
    const poly=[];
    for(let i=0;i<N;i++){
      const a=-Math.PI/2 + i*angStep;
      poly.push(`${CX + r*Math.cos(a)},${CY + r*Math.sin(a)}`);
    }
    const g = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    g.setAttribute('points', poly.join(' '));
    g.setAttribute('fill', 'none');
    g.setAttribute('stroke', 'rgba(255,255,255,0.08)');
    radarSVG.appendChild(g);
  }
  for(let i=0;i<N;i++){
    const a=-Math.PI/2 + i*angStep;
    const x=CX + R*Math.cos(a), y=CY + R*Math.sin(a);
    const line=document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1',CX); line.setAttribute('y1',CY);
    line.setAttribute('x2',x);  line.setAttribute('y2',y);
    line.setAttribute('stroke','rgba(255,255,255,.08)');
    radarSVG.appendChild(line);
    // label
    const text=document.createElementNS('http://www.w3.org/2000/svg','text');
    text.setAttribute('x',CX + (R+18)*Math.cos(a));
    text.setAttribute('y',CY + (R+18)*Math.sin(a));
    text.setAttribute('dominant-baseline','middle');
    text.setAttribute('text-anchor', Math.cos(a)>0.3?'start':(Math.cos(a)<-0.3?'end':'middle'));
    text.setAttribute('fill','#c8b6ff');
    text.setAttribute('font-size','12');
    text.textContent = `${STAGES[i].key}｜${STAGES[i].name}`;
    radarSVG.appendChild(text);
  }
  // area
  const pts=[];
  for(let i=0;i<N;i++){
    const ratio = (values[i]/10);
    const a=-Math.PI/2 + i*angStep;
    pts.push(`${CX + R*ratio*Math.cos(a)},${CY + R*ratio*Math.sin(a)}`);
  }
  const area=document.createElementNS('http://www.w3.org/2000/svg','polygon');
  area.setAttribute('points',pts.join(' '));
  area.setAttribute('fill','rgba(167,139,250,.25)');
  area.setAttribute('stroke','rgba(167,139,250,.95)');
  area.setAttribute('stroke-width','2');
  radarSVG.appendChild(area);
  scoresLine.textContent = STAGES.map((s,i)=>`${s.key}｜${s.name}：${values[i].toFixed(1)}`).join(' ｜ ');
}
document.getElementById('genRadar').addEventListener('click',()=>{
  const vals = computeStageAverages();
  drawRadar(vals);
  saveLastScores(vals);
  renderInfoCards(vals);
  pickTodayOils(vals);
});

/* ===== 七階資訊卡（自動展開最低兩階，含關鍵字＋行動建議＋瓶頸轉換） ===== */
const ACTIONS = {
  // 只列 S1, S4, S7, S2, S5, S3, S6（你的完整版本可擴充或抽出到 data/）
  '白｜能量覺知':{
    kw:['覺知','清明','面對當下'],
    act:[
      '寫三句「此刻我真實的感受是…」',
      '3 分鐘腹式呼吸（4-4-6），注意身體感受',
      '列出 1 個反覆念頭，標記：是事實還是解讀？'
    ]
  },
  '藍｜穩定與淨化':{
    kw:['穩定','釋放','界線'],
    act:[
      '寫下最困擾你的 1 件事，標註可控／不可控',
      '做 60 秒身體掃描，放鬆緊繃部位',
      '完成一件拖延小事並打勾'
    ]
  },
  '橙｜能量流動':{
    kw:['允許發生','對齊意圖','資源感','安全感'],
    act:[
      '用「我允許…」造句 3 句（對應今日焦點）',
      '回顧 1 次被支持的證據，寫下為何可複製',
      '今天主動請求一次幫助（小範圍即可）'
    ]
  },
  '黃｜內在力量':{
    kw:['最小步驟','可驗證','節奏','執行力'],
    act:[
      '把目標拆成 10 分鐘可完成的一步，現在就做',
      '設定今日 3 件 MIT',
      '完成後「公開回報」給可信任對象'
    ]
  },
  '綠｜共振與連結':{
    kw:['連結','價值感','貢獻','擴散'],
    act:[
      '分享一個小成果或洞見到社群／朋友',
      '邀請 1 人給具體回饋（3 句具體描述）',
      '主動建立一個合作可能（發出一則邀請）'
    ]
  },
  '靛藍｜意識擴展':{
    kw:['專注','回饋循環','韌性','迭代'],
    act:[
      '把卡點→調整 1 個微策略（A/B 嘗試）',
      '25 分鐘番茄鐘全程專注',
      '記錄 1 個有效回饋，明天沿用'
    ]
  },
  '紫｜靈魂整合':{
    kw:['總結經驗','固化習慣','結構化','長期化'],
    act:[
      '用 5 句話摘要本週 3 件學到＋1 改進',
      '把有效步驟寫成 Checklist 並固定到行程',
      '為下個週期設定一個可衡量指標（KPI）'
    ]
  }
};

const TRANSITION = {
  'S1→S2':['把「我觀察到…」改寫成「我願意放下…」×3','情緒書寫→身體放鬆收尾（頸肩／腹部）'],
  'S2→S3':['列出 3 個現有資源（人／物／技能）','寫 1 段：若一切對我有利，今天我允許什麼？'],
  'S3→S4':['產出「最小可行步驟」並在 10 分鐘內啟動','預約 1 個「行動時段」，行前只做準備清單'],
  'S4→S5':['把今日行動回饋記錄並做 1 次微調','建立 25 分鐘專注儀式，結束回顧 2 分鐘'],
  'S5→S6':['公開分享 1 個進展／案例，索取具體回饋','辨識最被共鳴的價值，明天主打該元素'],
  'S6→S7':['把有效做法寫成 SOP／Checklist','選一個可持續節奏（週／月）放進行事曆'],
  'S7→S1':['本週回顧 3 句＋下一輪新意圖 1 句','挑選 1 個欲精進的指標，設置觀測方式'],
};

function renderInfoCards(values){
  const list = values.map((v,i)=>({i,v})).sort((a,b)=>a.v-b.v);
  const low2 = [list[0].i, list[1].i];
  const box = document.getElementById('infoCards');
  box.innerHTML='';
  low2.forEach(idx=>{
    const title = `${STAGES[idx].key}｜${STAGES[idx].name}`;
    const kvs = ACTIONS[title]?.kw?.map(k=>`<span class="kv">${k}</span>`).join('') || '';
    const acts = (ACTIONS[title]?.act||[]).map(x=>`• ${x}`).join('<br>');
    const el = document.createElement('details');
    el.open = true;
    el.className='card';
    el.innerHTML = `
      <summary><b>${title}</b> ｜ 平均 <b>${values[idx].toFixed(1)}</b> 分 <span class="pill">觀照</span></summary>
      <div style="margin-top:8px">
        <div class="small">關鍵字：</div>
        <div class="kvs" style="margin:6px 0">${kvs}</div>
        <div class="small">行動建議：</div>
        <div style="margin-top:6px">${acts||'依你的分數趨勢稍後補充。'}</div>
      </div>
    `;
    box.appendChild(el);
  });
  // 瓶頸轉換（依序顯示 2 條）
  const tBox=document.createElement('div'); tBox.className='card'; tBox.style.marginTop='10px';
  const seq=['S1→S2','S2→S3','S3→S4','S4→S5','S5→S6','S6→S7','S7→S1'];
  const lines = seq.slice(0,2).map(k=>`<b>${k}</b>：${(TRANSITION[k]||[]).map(x=>'• '+x).join('　')}`);
  tBox.innerHTML = `<div class="small">瓶頸轉換提示：</div><div style="margin-top:6px">${lines.join('<br>')}</div>`;
  box.appendChild(tBox);
}

/* ===== 本地儲存上次分數，用於今日精油與旅程同步 ===== */
function saveLastScores(vals){ localStorage.setItem('e7_scores', JSON.stringify(vals)); }
function loadLastScores(){ try{ return JSON.parse(localStorage.getItem('e7_scores')||'[]'); }catch{return []}}

/* =========================
   新模組：旅程進度 / 徽章 / 隱藏卡
   ========================= */
const JOURNEYS = [
  { key:'d7',  label:'7 日能量挑戰',    days:7,  badge:'badge_7.png'  },
  { key:'d21', label:'21 日靈魂轉化',    days:21, badge:'badge_21.png' },
  { key:'d310',label:'310 日顯化日記',  days:310,badge:'badge_30.png' },
];

function readJourney(){
  try{ return JSON.parse(localStorage.getItem('e7_journey')||'{}');}catch{return {}}
}
function writeJourney(v){ localStorage.setItem('e7_journey', JSON.stringify(v)); }
function renderJourney(){
  const box=document.getElementById('journey-card'); box.innerHTML='';
  const data = readJourney();
  JOURNEYS.forEach(j=>{
    const done = Number(data[j.key]?.done||0);
    const p = Math.min(100, Math.round(done*100/j.days));
    const row = document.createElement('div'); row.className='card'; row.style.margin='8px 0';
    row.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div><b>${j.label}</b></div>
        <div class="small">${done} / ${j.days} 天</div>
      </div>
      <div class="progress" style="margin:8px 0"><div class="bar" style="width:${p}%"></div></div>
      <div class="row">
        <label class="row small" style="gap:8px;align-items:center">
          <input type="checkbox" id="chk_${j.key}"> 完成今日打卡
        </label>
        <div class="badge-row">
          <div class="badge ${done<j.days?'lock':''}">
            <img src="${j.badge}" alt="badge">
          </div>
        </div>
      </div>
    `;
    box.appendChild(row);
    row.querySelector(`#chk_${j.key}`).addEventListener('change',e=>{
      if(e.target.checked){
        data[j.key] = { done: Math.min(j.days, done+1), last: new Date().toISOString().slice(0,10) };
        writeJourney(data);
        renderJourney();
        maybeUnlock(j);
      }
    });
  });
}
function maybeUnlock(j){
  const data = readJourney(); const d=data[j.key]?.done||0;
  if(d===j.days){ // 解鎖隱藏卡
    showHiddenCard();
  }
}
async function showHiddenCard(){
  let list=[];
  try{ list = await (await fetch('data/hidden_cards.json')).json(); }
  catch{ list = [{title:'無名之光', text:'在你還需要名字之前，你已經是光。', action:'今天，靜默 60 秒，讓自己被看見。'}]; }
  const card = list[Math.floor(Math.random()*list.length)];
  alert(`🎴 隱藏靈魂卡｜${card.title}\n\n${card.text}\n\n行動：${card.action||'讓它成為今天最簡單的一步。'}`);
}

/* =========================
   新模組：呢喃神諭（每日一句 + 行動）
   ========================= */
function todayKey(prefix){ const d=new Date().toISOString().slice(0,10); return `${prefix}_${d}`; }
async function drawOracle(force=false){
  const k=todayKey('e7_oracle');
  if(!force){
    const cached = localStorage.getItem(k);
    if(cached){ document.getElementById('oracleBox').innerHTML=cached; return; }
  }
  let list=[];
  try{ list = await (await fetch('data/oracle_whispering.json')).json(); }
  catch{
    list = [
      {title:'成為', text:'你沒有變得更好，只是變得更真。', action:'允許自己出現，哪怕只是一分鐘。'},
      {title:'歸來', text:'你走過萬里，原來你一直都在這裡。', action:'今天，對自己說：我已經回來了。'}
    ];
  }
  const pick = list[Math.floor(Math.random()*list.length)];
  const html = `
    <div class="small" style="opacity:.9">「${pick.title}」</div>
    <div style="margin-top:6px">${pick.text}</div>
    <div class="small" style="margin-top:8px"><b>行動：</b>${pick.action||'把它變成 1 分鐘的小步驟。'}</div>
  `;
  document.getElementById('oracleBox').innerHTML = html;
  localStorage.setItem(k, html);
}
document.getElementById('drawOracle').addEventListener('click',()=>drawOracle(true));

/* =========================
   新模組：今日建議精油（YL）
   ========================= */
let YL = [];
async function ensureYL(){
  if(YL.length) return YL;
  try{ YL = await (await fetch('data/yl_blends.json')).json(); }
  catch{
    YL = [
      {name:'Peace & Calming', zh_name:'舒靜', description:'安撫情緒，帶來深層寧眠與內在平靜。'},
      {name:'Harmony', zh_name:'和諧（樂融）', description:'平衡身心能量，促進內在與關係的協調連結。'},
      {name:'Joy', zh_name:'喜悅', description:'喚醒內心喜悅與愛的頻率，帶來幸福感。'},
      {name:'Valor', zh_name:'勇氣', description:'支撐內在力量，幫助你跨越恐懼與挑戰。'},
      {name:'Forgiveness', zh_name:'寬恕', description:'釋放過去結，帶來心靈的自由與療癒。'}
    ];
  }
  return YL;
}
function oilBlock(o){ return `<div class="card"><b>${o.name}</b>（${o.zh_name||'—'}）<div class="small" style="margin-top:6px">${o.description||''}</div></div>`; }
async function pickTodayOils(vals=loadLastScores()){
  const box=document.getElementById('oilBox');
  if(!vals.length){ box.textContent='請先完成量表並生成雷達圖。'; return; }
  await ensureYL();
  // 以最低兩階為主各給 1–2 款（示意：隨機）
  const list = vals.map((v,i)=>({i,v})).sort((a,b)=>a.v-b.v);
  const idxs = [list[0].i, list[1].i];
  const picks = [];
  idxs.forEach(i=>{
    // 簡單隨機 1 款（實務可映射到階段→精油表）
    picks.push(YL[Math.floor(Math.random()*YL.length)]);
  });
  box.innerHTML = picks.map(oilBlock).join('');
}
document.getElementById('swapOil').addEventListener('click',()=>pickTodayOils());

/* =========================
   啟動
   ========================= */
(function boot(){
  renderJourney();
  drawOracle(false);
  const prev = loadLastScores();
  if(prev.length){ drawRadar(prev); renderInfoCards(prev); pickTodayOils(prev); }
})();
</script>

<!-- 額外 JS（若你有分拆的 extras.js，可保留；沒有就忽略） -->
<script src="extras.js" onerror="this.remove()"></script>

<!-- PWA（你既有的 sw.js 可沿用） -->
<script>
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').catch(()=>{}); }
</script>
</body>
</html>