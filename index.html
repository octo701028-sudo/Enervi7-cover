<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Enervi7 v8.0</title>
<link rel="manifest" href="manifest.json">
<style>
:root{
  --bg:#0f0b1a;
  --panel:#171226;
  --text:#eae6ff;
  --muted:#b9b0d9;
  --accent:#8b5cf6;
  --accent-2:#22d3ee;
  --good:#10b981;
  --warn:#f59e0b;
  --bad:#ef4444;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Hiragino Sans",Arial,"Apple Color Emoji","Segoe UI Emoji";}
.container{max-width:940px;margin:0 auto;padding:18px}
.header{background:linear-gradient(180deg,#5b21b6 0%, #3b0764 100%);padding:24px}
.h-title{font-weight:800;font-size:28px;margin:0}
.h-sub{opacity:.85;margin-top:6px}
.section{background:var(--panel);border-radius:14px;padding:18px;margin:14px 0;box-shadow:0 6px 18px rgba(0,0,0,.24)}
.section h2{margin:0 0 10px 0;font-size:22px;letter-spacing:1px}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#2a2144;color:#c4b5fd;margin-left:8px;font-size:12px}
.btn{border:0;background:var(--accent);color:white;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
.btn.secondary{background:#2a2144;color:#d6d3f8}
.btn:disabled{opacity:.5;cursor:not-allowed}
.subtitle{opacity:.8;margin:8px 0 4px}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.progress{width:100%;height:8px;background:#241b3c;border-radius:999px;overflow:hidden;position:relative}
.progress>span{display:block;height:100%;background:linear-gradient(90deg,#22d3ee,#8b5cf6);width:0%;transition:width 600ms ease}
.pill{padding:8px 14px;border-radius:999px;background:#231a3a}
.small{font-size:12px;opacity:.8}
.slider-wrap{background:#1e1633;border-radius:14px;padding:10px 14px;margin:10px 0}
label.q{display:block;margin:6px 0 6px;font-weight:700}
input[type=range]{width:100%}
.note{opacity:.85;font-size:12px;margin-top:6px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
.card{background:#1e1633;border-radius:12px;padding:12px}
.kv{display:inline-block;padding:2px 8px;border-radius:8px;background:#2b2242;color:#c7bdfd;margin-right:8px;font-size:12px}
.tag{display:inline-block;padding:2px 8px;border-radius:8px;background:#2b2242;color:#8ae0ff;margin:4px 6px 0 0}
.s7-item{margin:8px 0}
hr.sep{border:0;border-top:1px solid #2c2146;margin:12px 0}
.actions li{margin:6px 0}
/* Radar */
#radar{width:100%;height:320px;display:block}
svg{max-width:100%}
.axis-label{font-size:12px;fill:#c4b5fd}
/* confetti */
.confetti{position:fixed;left:0;top:0;width:100%;height:0;pointer-events:none;z-index:99}
.confetti i{position:absolute;top:-10px;opacity:.9;width:8px;height:14px;border-radius:2px;animation:drop 1400ms linear forwards}
@keyframes drop{to{transform:translateY(120vh) rotate(360deg);opacity:.98}}
/* oracle */
.oracle{font-size:15px;line-height:1.7}
.oracle .title{font-weight:900;font-size:18px;margin-bottom:6px}
.footer{opacity:.65;margin:20px auto;text-align:center}
kbd{background:#2a2144;border-radius:6px;padding:0 6px}
</style>
</head>
<body>
<div class="header">
  <div class="container">
    <h1 class="h-title">Enervi7 <span class="badge">v8.0</span></h1>
    <div class="h-sub">æ ¸å¿ƒå·²å°±ç·’ï¼š14 é¡Œé‡è¡¨ + ç´” SVG é›·é” + ä¸ƒéšè³‡è¨Šå¡ + æ—…ç¨‹é€²åº¦ï¼‹å¾½ç«  + éš±è—å¡ + ä»Šæ—¥å»ºè­°ç²¾æ²¹ + å‘¢å–ƒç¥è«­ï¼ˆé›¢ç·šå¯ç”¨ï¼‰</div>
  </div>
</div>

<div class="container">

  <div class="section" id="progressSec">
    <h2>ğŸŒ€ æ—…ç¨‹é€²åº¦</h2>
    <div class="subtitle small">æ¯æ—¥æ‰“å¡æœƒåŒæ™‚æ¨é€²ä¸‰æ¢æ—…ç¨‹ã€‚æ»¿ 7 / 21 / 30 å¤©æ™‚æœƒé»äº®å¾½ç« ä¸¦è§£é– 1 å¼µéš±è—å¡ã€‚</div>
    <div class="row">
      <div style="flex:1">
        <div class="small">7 æ—¥èƒ½é‡æŒ‘æˆ°ï¼š<span id="p7Txt">0</span> å¤©</div>
        <div class="progress"><span id="p7Bar"></span></div>
      </div>
      <div class="pill" id="b7">7 æ—¥å¾½ç« </div>
    </div>
    <div class="row">
      <div style="flex:1">
        <div class="small">21 æ—¥éˆé­‚è½‰åŒ–ï¼š<span id="p21Txt">0</span> å¤©</div>
        <div class="progress"><span id="p21Bar"></span></div>
      </div>
      <div class="pill" id="b21">21 æ—¥å¾½ç« </div>
    </div>
    <div class="row">
      <div style="flex:1">
        <div class="small">30 æ—¥é¡¯åŒ–æ—¥è¨˜ï¼š<span id="p30Txt">0</span> å¤©</div>
        <div class="progress"><span id="p30Bar"></span></div>
      </div>
      <div class="pill" id="b30">30 æ—¥å¾½ç« </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="checkinBtn" class="btn">âœ… å®Œæˆä»Šæ—¥æ‰“å¡</button>
      <div class="small" id="checkinHint"></div>
    </div>
  </div>

  <div class="section">
    <h2>ğŸ§­ 14 é¡Œé‡è¡¨ï¼ˆ0â€“10ï¼‰</h2>
    <div class="small">0 = å®Œå…¨ä¸ç¬¦åˆï¼å¹¾ä¹æ²’æœ‰ã€€ï½œã€€10 = éå¸¸ç¬¦åˆï¼å¹¾ä¹ç¸½æ˜¯</div>
    <div id="qs"></div>
    <div class="row">
      <button class="btn" id="genRadar">ç”Ÿæˆèƒ½é‡é›·é”åœ–</button>
      <div class="small">ç›®å‰å¹³å‡åˆ†æœƒåæ˜ åˆ°ä¸‹æ–¹è³‡è¨Šå¡èˆ‡å»ºè­°ã€‚</div>
    </div>
  </div>

  <div class="section">
    <h2>ğŸ“ˆ èƒ½é‡é›·é”åœ–</h2>
    <svg id="radar" viewBox="0 0 420 420"></svg>
  </div>

  <div class="section">
    <h2>ğŸƒ å‘¢å–ƒç¥è«­ï¼ˆWhispering Oracleï¼‰</h2>
    <div id="oracleBox" class="oracle"></div>
    <div class="row" style="margin-top:8px">
      <button id="drawOracle" class="btn secondary">æŠ½ä¸€å¼µ</button>
      <div class="small">åŒä¸€å¤©åƒ…é¡¯ç¤ºä¸€å¼µï¼›éš”å¤©è‡ªå‹•åˆ·æ–°ã€‚</div>
    </div>
  </div>

  <div class="section">
    <h2>ğŸ«— ä»Šæ—¥å»ºè­°ç²¾æ²¹</h2>
    <div id="oilBox" class="small">è«‹å…ˆå®Œæˆé‡è¡¨ä¸¦ç”Ÿæˆé›·é”åœ–ã€‚</div>
    <div class="row" style="margin-top:8px">
      <button id="swapOil" class="btn secondary">æ›ä¸€æ¬¾ï¼ˆç¤ºæ„ï¼‰</button>
    </div>
  </div>

  <div class="section">
    <h2>ğŸŒˆ ä¸ƒéšè³‡è¨Šå¡ï¼ˆè‡ªå‹•å±•é–‹æœ€ä½å…©éšï¼‰</h2>
    <div id="s7"></div>
  </div>

  <div class="section">
    <h2>ğŸ—ï¸ éš±è—éˆé­‚å¡ï¼ˆ33 å¼µï¼‰</h2>
    <div id="unlockInfo" class="small">å®Œæˆ 7 / 21 / 30 æ—¥é€±æœŸæœƒå„è§£é–ä¸€å¼µã€‚</div>
    <div id="hiddenCard" class="card" style="margin-top:8px;display:none"></div>
  </div>

  <div class="footer">PWA é›¢ç·šå¯ç”¨ã€‚é‡æ–°æ•´ç†å¯ä¿å­˜é€²åº¦ã€‚è‹¥æƒ³é‡ç½®ï¼ŒæŒ‰ <kbd>æ¸…é™¤ç€è¦½è³‡æ–™</kbd>ã€‚</div>

</div>
<div class="confetti" id="confetti"></div>
<script>
const STAGES=[
 {key:'white', zh:'ç™½', name:'èƒ½é‡è¦ºçŸ¥', color:'#f8fafc', hex:'#f8fafc'},
 {key:'blue', zh:'è—', name:'ç©©å®šèˆ‡æ·¨åŒ–', color:'#93c5fd', hex:'#93c5fd'},
 {key:'orange', zh:'æ©™', name:'èƒ½é‡æµå‹•', color:'#fdba74', hex:'#fdba74'},
 {key:'yellow', zh:'é»ƒ', name:'å…§åœ¨åŠ›é‡', color:'#fde047', hex:'#fde047'},
 {key:'green', zh:'ç¶ ', name:'å…±æŒ¯èˆ‡é€£çµ', color:'#86efac', hex:'#86efac'},
 {key:'indigo', zh:'é›è—', name:'æ„è­˜æ“´å±•', color:'#a78bfa', hex:'#a78bfa'},
 {key:'purple', zh:'ç´«', name:'éˆé­‚æ•´åˆ', color:'#d8b4fe', hex:'#d8b4fe'},
];
const QUESTIONS=[
 {stage:0, text:'æˆ‘èƒ½æ¸…æ¥šè¦ºå¯Ÿè‡ªå·±æ­¤åˆ»çš„èº«å¿ƒç‹€æ…‹ã€‚'},
 {stage:0, text:'æˆ‘èƒ½åœ¨æ··äº‚æ™‚ï¼Œè¿…é€ŸæŠŠæ³¨æ„åŠ›å¸¶å›ç•¶ä¸‹ã€‚'},
 {stage:1, text:'é¢å°å£“åŠ›æˆ–è¡çªæ™‚ï¼Œæˆ‘èƒ½ä¿æŒå†·éœä¸å¤±è¡¡ã€‚'},
 {stage:1, text:'æˆ‘èƒ½æœ‰æ•ˆåœ°é‡‹æ”¾ç´¯ç©çš„è² é¢æƒ…ç·’èˆ‡é›œå¿µã€‚'},
 {stage:2, text:'æˆ‘å¸¸æ„Ÿè¦ºéˆæ„Ÿï¼æƒ…æ„Ÿåœ¨é«”å…§è‡ªç„¶æµå‹•ã€‚'},
 {stage:2, text:'æˆ‘èƒ½é †å‹¢èª¿æ•´æ­¥èª¿ï¼Œä¸åƒµç¡¬æˆ–å¡ä½ã€‚'},
 {stage:3, text:'åšæ±ºå®šæ™‚ï¼Œæˆ‘èƒ½å …å®šåœ°é¸æ“‡å°è‡ªå·±çœŸçš„å¥½çš„äº‹ã€‚'},
 {stage:3, text:'é‡åˆ°æŒ‘æˆ°ï¼Œæˆ‘ä»èƒ½ç›¸ä¿¡è‡ªå·±ä¸¦å¾€å‰ä¸€æ­¥ã€‚'},
 {stage:4, text:'æˆ‘èƒ½çœŸèª è¡¨é”ï¼Œä¹Ÿæ¨‚æ–¼å‚¾è½ä»–äººã€‚'},
 {stage:4, text:'æˆ‘èƒ½æ„Ÿåˆ°è‡ªå·±èˆ‡ä»–äººã€èˆ‡ä¸–ç•Œæ˜¯é€£çµçš„ã€‚'},
 {stage:5, text:'æˆ‘ä¿¡ä»»ç›´è¦ºï¼Œä¸”èƒ½å¾ä¸­ç²å¾—æœ‰ç”¨çš„æŒ‡å¼•ã€‚'},
 {stage:5, text:'æˆ‘èƒ½å¾æ—¥å¸¸äº‹ä»¶çœ‹è¦‹æ›´æ·±çš„æ´è¦‹èˆ‡æ„ç¾©ã€‚'},
 {stage:6, text:'æˆ‘èƒ½æŠŠéå»çš„ç¶“é©—æ•´åˆæˆåŠ›é‡ï¼Œè€Œä¸æ˜¯æ·é–ã€‚'},
 {stage:6, text:'æˆ‘å¸¸æ„Ÿåˆ°è‡ªå·±å®Œæ•´ã€å°ç”Ÿå‘½æ–¹å‘è¸å¯¦å®‰å¿ƒã€‚'},
];
const S7_DETAIL={
 white:{
  kw:['è¦ºçŸ¥','æ¸…æ˜','é¢å°ç•¶ä¸‹'],
  actions:['å¯«ä¸‰å¥ã€Œæ­¤åˆ»æˆ‘çœŸå¯¦çš„æ„Ÿå—æ˜¯â€¦ã€','3 åˆ†é˜è…¹å¼å‘¼å¸ï¼ˆ4-4-6ï¼‰ï¼Œæ³¨æ„èº«é«”æ„Ÿå—','åˆ—å‡º 1 å€‹å¿µé ­ä¸¦æ¨™è¨˜ï¼šæ˜¯äº‹å¯¦é‚„æ˜¯è§£è®€ï¼Ÿ']
 },
 blue:{
  kw:['ç©©å®š','é‡‹æ”¾','ç•Œç·š'],
  actions:['å¯«ä¸‹æœ€å›°æ“¾ä½ çš„ 1 ä»¶äº‹ï¼Œæ¨™è¨»å¯æ§/ä¸å¯æ§','åš 60 ç§’èº«é«”æ”¾é¬†ï¼ˆé ¸è‚©æˆ–è…¹éƒ¨ï¼‰','å®Œæˆ 1 ä»¶æ‹–å»¶å°äº‹ä¸¦æ‰“å‹¾']
 },
 orange:{
  kw:['æµå‹•','å¾®èª¿','éŸŒæ€§'],
  actions:['æŠŠå¡é»â†’èª¿æ•´ 1 å€‹å¾®ç­–ç•¥ï¼ˆA/B æ¸¬è©¦ï¼‰','25 åˆ†é˜ç•ªèŒ„é˜å…¨ç¨‹å°ˆæ³¨','è¨˜éŒ„ 1 å€‹æœ‰æ•ˆå›é¥‹ï¼Œæ˜å¤©æ²¿ç”¨']
 },
 yellow:{
  kw:['æ±ºæ–·','æ„å¿—','è¡Œå‹•åŠ›'],
  actions:['æŠŠç›®æ¨™æ‹†æˆ 10 åˆ†é˜çš„ä¸€æ­¥ï¼Œç¾åœ¨å°±åš','è¨­å®šä»Šæ—¥ 3 ä»¶ MIT','å®Œæˆå¾Œå›å ±çµ¦å¯ä¿¡ä»»å°è±¡']
 },
 green:{
  kw:['é€£çµ','å…±é³´','è²¢ç»'],
  actions:['åˆ†äº«ä¸€å€‹å°æˆæœåˆ°ç¤¾ç¾¤/æœ‹å‹','é‚€è«‹ 1 äººçµ¦å…·é«”å›é¥‹ï¼ˆ3 å¥ï¼‰','ä¸»å‹•å»ºç«‹ä¸€å€‹åˆä½œå¯èƒ½ï¼ˆç™¼ä¸€å‰‡é‚€è«‹ï¼‰']
 },
 indigo:{
  kw:['ç›´è¦º','æ´è¦‹','é¡˜æ™¯'],
  actions:['å¯« 3 å¥ã€Œæˆ‘å…è¨±â€¦ã€å°æ‡‰ä»Šæ—¥ç„¦é»','å›é¡§ä¸€æ¬¡è¢«æ”¯æŒçš„è­‰æ“šä¸¦è¨˜éŒ„å¯è¤‡è£½é»','ä»Šå¤©ä¸»å‹•è«‹æ±‚ä¸€æ¬¡å¹«åŠ©ï¼ˆå°ç¯„åœï¼‰']
 },
 purple:{
  kw:['æ•´åˆ','çµæ§‹åŒ–','é•·æœŸåŒ–'],
  actions:['ç”¨ 5 å¥è©±æ‘˜è¦æœ¬é€± 3 å­¸åˆ° + 1 æ”¹é€²','æŠŠæœ‰æ•ˆæ­¥é©Ÿå¯«æˆ Checklist ä¸¦å›ºå®šé€²è¡Œç¨‹','ç‚ºä¸‹å€‹é€±æœŸè¨­å®šä¸€å€‹å¯è¡¡é‡æŒ‡æ¨™ï¼ˆKPIï¼‰']
 }
};
const TRANSITIONS={
 'S1â†’S2':['æŠŠã€Œæˆ‘è§€å¯Ÿåˆ°â€¦ã€æ”¹å¯«æˆã€Œæˆ‘é¡˜æ„æ”¾ä¸‹â€¦ã€x3','æƒ…ç·’æ›¸å¯«â†’èº«é«”æ”¾é¬†æ”¶å°¾ï¼ˆé ¸è‚©ï¼è…¹éƒ¨ï¼‰'],
 'S2â†’S3':['åˆ—å‡º 3 å€‹ç¾æœ‰è³‡æºï¼ˆäºº/ç‰©/æŠ€èƒ½ï¼‰','å¯«ï¼šè‹¥ä¸€åˆ‡å°æˆ‘æœ‰åˆ©ï¼Œä»Šå¤©æˆ‘å…è¨±ä»€éº¼ï¼Ÿ'],
 'S3â†’S4':['ç”¢å‡ºã€Œæœ€å°å¯è¡Œæ­¥é©Ÿã€ä¸¦åœ¨ 10 åˆ†é˜å…§å•Ÿå‹•','é ç´„ 1 å€‹ã€Œè¡Œå‹•æ™‚æ®µã€ï¼Œè¡Œå‰åªåšæº–å‚™æ¸…å–®'],
 'S4â†’S5':['æŠŠä»Šæ—¥å›é¥‹è¨˜éŒ„ä¸¦åšä¸€æ¬¡å¾®èª¿','å»ºç«‹ 25 åˆ†é˜å°ˆæ³¨å„€å¼ï¼ŒçµæŸå›é¡§ 2 åˆ†é˜'],
 'S5â†’S6':['å…¬é–‹åˆ†äº«ä¸€å€‹é€²å±•ä¸¦ç´¢å–å…·é«”å›é¥‹','è¾¨è­˜æœ€è¢«å…±é³´çš„åƒ¹å€¼ï¼Œæ˜å¤©ä¸»æ‰“è©²å…ƒç´ '],
 'S6â†’S7':['æŠŠæœ‰æ•ˆåšæ³•å¯«æˆ SOP/Checklist','é¸ä¸€å€‹å¯æŒçºŒç¯€å¥ï¼ˆé€±/æœˆï¼‰æ”¾é€²è¡Œäº‹æ›†'],
 'S7â†’S1':['æœ¬é€±å›é¡§ 3 å¥ï¼‹ä¸‹ä¸€è¼ªæ–°æ„åœ– 1 å¥','æŒ‘é¸ 1 å€‹æ¬²ç²¾é€²çš„æŒ‡æ¨™ï¼Œè¨­ç½®è§€æ¸¬æ–¹å¼']
};

// Build questions UI
const qsDiv=document.getElementById('qs');
const sliders=[];
QUESTIONS.forEach((q,i)=>{
  const w=document.createElement('div');w.className='slider-wrap';
  const s=STAGES[q.stage]; 
  w.innerHTML=`<label class="q">${i+1}. <b>${s.zh}</b>ï½œ<b>${s.name}</b>ï½œ${q.text}</label>
  <input type="range" min="0" max="10" step="1" value="5" data-stage="${q.stage}"/>
  <div class="note">ç›®å‰ï¼š<span class="cur">5</span> / 10</div>`;
  const range=w.querySelector('input'); const cur=w.querySelector('.cur');
  range.addEventListener('input',()=>cur.textContent=range.value);
  sliders.push(range); qsDiv.appendChild(w);
});

// Radar draw
const svg=document.getElementById('radar');
function polarToXY(cx,cy,r,angle){const rad=(angle-90)*Math.PI/180;return [cx+r*Math.cos(rad), cy+r*Math.sin(rad)];}
function drawRadar(values){ // values length 7 (0..10)
  const W=420,H=420,cx=W/2,cy=H/2,maxR=150,lvl=5;
  svg.innerHTML='';
  // grid
  for(let k=1;k<=lvl;k++){
    const r=maxR*k/lvl;
    let d='';
    for(let i=0;i<7;i++){
      const [x,y]=polarToXY(cx,cy,r,(360/7)*i);
      d+= (i===0?'M':'L')+x+','+y;
    }
    d+='Z';
    const p=document.createElementNS('http://www.w3.org/2000/svg','path');
    p.setAttribute('d',d); p.setAttribute('fill','none');
    p.setAttribute('stroke','#2c2146'); p.setAttribute('stroke-width','1');
    svg.appendChild(p);
  }
  // axes & labels
  for(let i=0;i<7;i++){
    const [x,y]=polarToXY(cx,cy,maxR,(360/7)*i);
    const line=document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1',cx); line.setAttribute('y1',cy);
    line.setAttribute('x2',x); line.setAttribute('y2',y);
    line.setAttribute('stroke','#2c2146'); svg.appendChild(line);
    const [lx,ly]=polarToXY(cx,cy,maxR+18,(360/7)*i);
    const t=document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x',lx); t.setAttribute('y',ly); t.setAttribute('text-anchor','middle'); t.setAttribute('class','axis-label');
    t.textContent=STAGES[i].zh+'ï½œ'+STAGES[i].name;
    svg.appendChild(t);
  }
  // data polygon
  let d='';
  for(let i=0;i<7;i++){
    const r=maxR*(values[i]/10);
    const [x,y]=polarToXY(cx,cy,r,(360/7)*i);
    d+= (i===0?'M':'L')+x+','+y;
  }
  d+='Z';
  const poly=document.createElementNS('http://www.w3.org/2000/svg','path');
  poly.setAttribute('d',d);
  poly.setAttribute('fill','rgba(139,92,246,.35)');
  poly.setAttribute('stroke','#8b5cf6');
  poly.setAttribute('stroke-width','2');
  svg.appendChild(poly);
}
function getAverages(){
  const sums=[0,0,0,0,0,0,0], cnt=[0,0,0,0,0,0,0];
  sliders.forEach(r=>{const s=+r.dataset.stage; sums[s]+=+r.value; cnt[s]++;});
  return sums.map((v,i)=> Number((v/cnt[i]).toFixed(1)));
}

function minTwoIdx(arr){
  // return indices of two smallest elements
  let idx=[0,1,2,3,4,5,6].sort((a,b)=>arr[a]-arr[b]); return idx.slice(0,2);
}

function renderS7(values){
  const idx=minTwoIdx(values);
  const wrap=document.getElementById('s7'); wrap.innerHTML='';
  idx.forEach(i=>{
    const st=STAGES[i];
    const detail=S7_DETAIL[{0:'white',1:'blue',2:'orange',3:'yellow',4:'green',5:'indigo',6:'purple'}[i]];
    const card=document.createElement('div'); card.className='card';
    const score=values[i];
    card.innerHTML=`<div class="s7-item"><span class="kv">${st.zh}ï½œ${st.name}</span><span class="kv">å¹³å‡ ${score}</span></div>
      <div class="s7-item"><b>é—œéµå­—</b>ï¼š${detail.kw.map(k=>`<span class="tag">${k}</span>`).join('')}</div>
      <div class="s7-item"><b>è¡Œå‹•å»ºè­°</b>ï¼š<ul class="actions">${detail.actions.map(a=>`<li>${a}</li>`).join('')}</ul></div>
      <hr class="sep"><div class="s7-item"><b>ç“¶é ¸è½‰æ›</b>ï¼š<div class="small">${transitionText(i)}</div></div>`;
    wrap.appendChild(card);
  });
}
function transitionText(i){
  const map=['S1â†’S2','S2â†’S3','S3â†’S4','S4â†’S5','S5â†’S6','S6â†’S7','S7â†’S1'];
  const key=map[i]; const tips=TRANSITIONS[key];
  return `<div class="s7-item"><div class="kv">${key}</div><ul class="actions">${tips.map(t=>`<li>${t}</li>`).join('')}</ul></div>`;
}

// Oracle (daily)
let ORACLES=[];
fetch('oracle_whispering.json').then(r=>r.json()).then(list=>{ORACLES=list; ensureOracleToday();});
function ensureOracleToday(){
  const box=document.getElementById('oracleBox');
  const key='oracleDate', keyIdx='oracleIdx';
  const today=new Date().toISOString().slice(0,10);
  let d=localStorage.getItem(key), idx=localStorage.getItem(keyIdx);
  if(d!==today || idx===null){
    idx=Math.floor(Math.random()*ORACLES.length);
    localStorage.setItem(key,today);
    localStorage.setItem(keyIdx,idx);
  }
  const o=ORACLES[+idx];
  box.innerHTML=`<div class="title">ã€Œ${o.title}ã€</div><div>${o.text}</div><div class="small" style="margin-top:6px">è¡Œå‹•ï¼š${o.action}</div>`;
}
document.getElementById('drawOracle').addEventListener('click',ensureOracleToday);

// Oils
let OILS=[];
fetch('yl_blends.json').then(r=>r.json()).then(list=>OILS=list);
function suggestOil(values){
  // pick by lowest stage -> choose from mapping
  const idx=minTwoIdx(values)[0];
  const map={
    0:['Peace & Calming','Clarity','Awaken'],
    1:['Release','Stress Away','AromaEase'],
    2:['En-R-G-E','Inspiration','Dream Catcher'],
    3:['Valor','Magnify Your Purpose','Acceptance'],
    4:['Harmony','Joy','Gratitude'],
    5:['Transformation','Into the Future','Envision'],
    6:['Present Time','Forgiveness','Sacred Mountain']
  };
  const pool=map[idx];
  const picks=pool.map(nm=>OILS.find(o=>o.name===nm)).filter(Boolean);
  return picks[Math.floor(Math.random()*picks.length)] || OILS[Math.floor(Math.random()*OILS.length)];
}
function renderOil(o){
  const box=document.getElementById('oilBox');
  if(!o){ box.textContent='è³‡æ–™å°šæœªè¼‰å…¥æˆ–å°šæœªç”Ÿæˆé›·é”åœ–ã€‚'; return; }
  box.innerHTML=`<div class="card"><b>${o.name}</b>ï¼ˆ${o.zh_name}ï¼‰<br>${o.description}</div>`;
}
document.getElementById('swapOil').addEventListener('click',()=>{
  const vals=getAverages(); renderOil(suggestOil(vals));
});

// Generate Radar & S7 & Oil
document.getElementById('genRadar').addEventListener('click',()=>{
  const vals=getAverages();
  drawRadar(vals); renderS7(vals); renderOil(suggestOil(vals));
});

// Progress + badges + hidden cards
const confetti=document.getElementById('confetti');
function celebrate(){
  // simple confetti
  confetti.innerHTML='';
  const colors=['#22d3ee','#34d399','#fde047','#fb7185','#a78bfa','#60a5fa'];
  for(let i=0;i<120;i++){
    const el=document.createElement('i');
    el.style.left=Math.random()*100+'%';
    el.style.background=colors[Math.floor(Math.random()*colors.length)];
    el.style.animationDelay=(Math.random()*600)+'ms';
    confetti.appendChild(el);
  }
  setTimeout(()=> confetti.innerHTML='',1800);
}
function loadProg(){ return JSON.parse(localStorage.getItem('e7_prog')||'{"p7":0,"p21":0,"p30":0,"cards":0,"last":""}');}
function saveProg(p){ localStorage.setItem('e7_prog',JSON.stringify(p));}
function renderProg(){
  const p=loadProg();
  const set=(id,val,den)=>{
    document.getElementById(id+'Txt').textContent=val;
    document.getElementById(id+'Bar').style.width=(100*Math.min(val,den)/den)+'%';
  };
  set('p7',p.p7,7); set('p21',p.p21,21); set('p30',p.p30,30);
  document.getElementById('checkinHint').textContent= p.last===todayStr()? 'ä»Šå¤©å·²æ‰“å¡ âœ…' : 'å°šæœªæ‰“å¡';
}
function todayStr(){ return new Date().toISOString().slice(0,10);}
function unlockCard(){
  fetch('hidden_cards.json').then(r=>r.json()).then(cards=>{
    const p=loadProg(); const idx=p.cards % cards.length;
    const c=cards[idx];
    p.cards++; saveProg(p);
    const box=document.getElementById('hiddenCard');
    box.style.display='block'; box.innerHTML=`<b>æ–°è§£é– #${p.cards}ï¼š</b> ${c.title}<hr class="sep"><div>${c.text}</div>`;
  });
}
document.getElementById('checkinBtn').addEventListener('click',()=>{
  const p=loadProg(); const t=todayStr();
  if(p.last===t){ alert('ä»Šå¤©å·²æ‰“å¡ã€‚'); return; }
  p.last=t; p.p7++; p.p21++; p.p30++;
  let unlocked=false;
  if(p.p7>=7){ p.p7=0; unlocked=true; celebrate(); document.getElementById('b7').textContent='7 æ—¥å¾½ç«  âœ¨'; }
  if(p.p21>=21){ p.p21=0; unlocked=true; celebrate(); document.getElementById('b21').textContent='21 æ—¥å¾½ç«  âœ¨'; }
  if(p.p30>=30){ p.p30=0; unlocked=true; celebrate(); document.getElementById('b30').textContent='30 æ—¥å¾½ç«  âœ¨ï¼ˆéˆé­‚æ•´åˆå¡ï¼‰'; }
  saveProg(p); renderProg();
  if(unlocked) unlockCard();
});
renderProg();

// PWA
if('serviceWorker' in navigator){ window.addEventListener('load',()=>navigator.serviceWorker.register('sw.js'));}
</script>
</body>
</html>
