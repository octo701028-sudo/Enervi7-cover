<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Enervi7 v8.0</title>
<link rel="manifest" href="manifest.json">
<style>
:root{
  --bg:#0f0b1a;
  --panel:#171226;
  --text:#eae6ff;
  --muted:#b9b0d9;
  --accent:#8b5cf6;
  --accent-2:#22d3ee;
  --good:#10b981;
  --warn:#f59e0b;
  --bad:#ef4444;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Hiragino Sans",Arial,"Apple Color Emoji","Segoe UI Emoji";}
.container{max-width:940px;margin:0 auto;padding:18px}
.header{background:linear-gradient(180deg,#5b21b6 0%, #3b0764 100%);padding:24px}
.h-title{font-weight:800;font-size:28px;margin:0}
.h-sub{opacity:.85;margin-top:6px}
.section{background:var(--panel);border-radius:14px;padding:18px;margin:14px 0;box-shadow:0 6px 18px rgba(0,0,0,.24)}
.section h2{margin:0 0 10px 0;font-size:22px;letter-spacing:1px}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#2a2144;color:#c4b5fd;margin-left:8px;font-size:12px}
.btn{border:0;background:var(--accent);color:white;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
.btn.secondary{background:#2a2144;color:#d6d3f8}
.btn:disabled{opacity:.5;cursor:not-allowed}
.subtitle{opacity:.8;margin:8px 0 4px}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.progress{width:100%;height:8px;background:#241b3c;border-radius:999px;overflow:hidden;position:relative}
.progress>span{display:block;height:100%;background:linear-gradient(90deg,#22d3ee,#8b5cf6);width:0%;transition:width 600ms ease}
.pill{padding:8px 14px;border-radius:999px;background:#231a3a}
.small{font-size:12px;opacity:.8}
.slider-wrap{background:#1e1633;border-radius:14px;padding:10px 14px;margin:10px 0}
label.q{display:block;margin:6px 0 6px;font-weight:700}
input[type=range]{width:100%}
.note{opacity:.85;font-size:12px;margin-top:6px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
.card{background:#1e1633;border-radius:12px;padding:12px}
.kv{display:inline-block;padding:2px 8px;border-radius:8px;background:#2b2242;color:#c7bdfd;margin-right:8px;font-size:12px}
.tag{display:inline-block;padding:2px 8px;border-radius:8px;background:#2b2242;color:#8ae0ff;margin:4px 6px 0 0}
.s7-item{margin:8px 0}
hr.sep{border:0;border-top:1px solid #2c2146;margin:12px 0}
.actions li{margin:6px 0}
/* Radar */
#radar{width:100%;height:320px;display:block}
svg{max-width:100%}
.axis-label{font-size:12px;fill:#c4b5fd}
/* confetti */
.confetti{position:fixed;left:0;top:0;width:100%;height:0;pointer-events:none;z-index:99}
.confetti i{position:absolute;top:-10px;opacity:.9;width:8px;height:14px;border-radius:2px;animation:drop 1400ms linear forwards}
@keyframes drop{to{transform:translateY(120vh) rotate(360deg);opacity:.98}}
/* oracle */
.oracle{font-size:15px;line-height:1.7}
.oracle .title{font-weight:900;font-size:18px;margin-bottom:6px}
.footer{opacity:.65;margin:20px auto;text-align:center}
kbd{background:#2a2144;border-radius:6px;padding:0 6px}
</style>
</head>
<body>
<div class="header">
  <div class="container">
    <h1 class="h-title">Enervi7 <span class="badge">v8.0</span></h1>
    <div class="h-sub">核心已就緒：14 題量表 + 純 SVG 雷達 + 七階資訊卡 + 旅程進度＋徽章 + 隱藏卡 + 今日建議精油 + 呢喃神諭（離線可用）</div>
  </div>
</div>

<div class="container">

  <div class="section" id="progressSec">
    <h2>🌀 旅程進度</h2>
    <div class="subtitle small">每日打卡會同時推進三條旅程。滿 7 / 21 / 30 天時會點亮徽章並解鎖 1 張隱藏卡。</div>
    <div class="row">
      <div style="flex:1">
        <div class="small">7 日能量挑戰：<span id="p7Txt">0</span> 天</div>
        <div class="progress"><span id="p7Bar"></span></div>
      </div>
      <div class="pill" id="b7">7 日徽章</div>
    </div>
    <div class="row">
      <div style="flex:1">
        <div class="small">21 日靈魂轉化：<span id="p21Txt">0</span> 天</div>
        <div class="progress"><span id="p21Bar"></span></div>
      </div>
      <div class="pill" id="b21">21 日徽章</div>
    </div>
    <div class="row">
      <div style="flex:1">
        <div class="small">30 日顯化日記：<span id="p30Txt">0</span> 天</div>
        <div class="progress"><span id="p30Bar"></span></div>
      </div>
      <div class="pill" id="b30">30 日徽章</div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="checkinBtn" class="btn">✅ 完成今日打卡</button>
      <div class="small" id="checkinHint"></div>
    </div>
  </div>

  <div class="section">
    <h2>🧭 14 題量表（0–10）</h2>
    <div class="small">0 = 完全不符合／幾乎沒有　｜　10 = 非常符合／幾乎總是</div>
    <div id="qs"></div>
    <div class="row">
      <button class="btn" id="genRadar">生成能量雷達圖</button>
      <div class="small">目前平均分會反映到下方資訊卡與建議。</div>
    </div>
  </div>

  <div class="section">
    <h2>📈 能量雷達圖</h2>
    <svg id="radar" viewBox="0 0 420 420"></svg>
  </div>

  <div class="section">
    <h2>🃏 呢喃神諭（Whispering Oracle）</h2>
    <div id="oracleBox" class="oracle"></div>
    <div class="row" style="margin-top:8px">
      <button id="drawOracle" class="btn secondary">抽一張</button>
      <div class="small">同一天僅顯示一張；隔天自動刷新。</div>
    </div>
  </div>

  <div class="section">
    <h2>🫗 今日建議精油</h2>
    <div id="oilBox" class="small">請先完成量表並生成雷達圖。</div>
    <div class="row" style="margin-top:8px">
      <button id="swapOil" class="btn secondary">換一款（示意）</button>
    </div>
  </div>

  <div class="section">
    <h2>🌈 七階資訊卡（自動展開最低兩階）</h2>
    <div id="s7"></div>
  </div>

  <div class="section">
    <h2>🗝️ 隱藏靈魂卡（33 張）</h2>
    <div id="unlockInfo" class="small">完成 7 / 21 / 30 日週期會各解鎖一張。</div>
    <div id="hiddenCard" class="card" style="margin-top:8px;display:none"></div>
  </div>

  <div class="footer">PWA 離線可用。重新整理可保存進度。若想重置，按 <kbd>清除瀏覽資料</kbd>。</div>

</div>
<div class="confetti" id="confetti"></div>
<script>
const STAGES=[
 {key:'white', zh:'白', name:'能量覺知', color:'#f8fafc', hex:'#f8fafc'},
 {key:'blue', zh:'藍', name:'穩定與淨化', color:'#93c5fd', hex:'#93c5fd'},
 {key:'orange', zh:'橙', name:'能量流動', color:'#fdba74', hex:'#fdba74'},
 {key:'yellow', zh:'黃', name:'內在力量', color:'#fde047', hex:'#fde047'},
 {key:'green', zh:'綠', name:'共振與連結', color:'#86efac', hex:'#86efac'},
 {key:'indigo', zh:'靛藍', name:'意識擴展', color:'#a78bfa', hex:'#a78bfa'},
 {key:'purple', zh:'紫', name:'靈魂整合', color:'#d8b4fe', hex:'#d8b4fe'},
];
const QUESTIONS=[
 {stage:0, text:'我能清楚覺察自己此刻的身心狀態。'},
 {stage:0, text:'我能在混亂時，迅速把注意力帶回當下。'},
 {stage:1, text:'面對壓力或衝突時，我能保持冷靜不失衡。'},
 {stage:1, text:'我能有效地釋放累積的負面情緒與雜念。'},
 {stage:2, text:'我常感覺靈感／情感在體內自然流動。'},
 {stage:2, text:'我能順勢調整步調，不僵硬或卡住。'},
 {stage:3, text:'做決定時，我能堅定地選擇對自己真的好的事。'},
 {stage:3, text:'遇到挑戰，我仍能相信自己並往前一步。'},
 {stage:4, text:'我能真誠表達，也樂於傾聽他人。'},
 {stage:4, text:'我能感到自己與他人、與世界是連結的。'},
 {stage:5, text:'我信任直覺，且能從中獲得有用的指引。'},
 {stage:5, text:'我能從日常事件看見更深的洞見與意義。'},
 {stage:6, text:'我能把過去的經驗整合成力量，而不是枷鎖。'},
 {stage:6, text:'我常感到自己完整、對生命方向踏實安心。'},
];
const S7_DETAIL={
 white:{
  kw:['覺知','清明','面對當下'],
  actions:['寫三句「此刻我真實的感受是…」','3 分鐘腹式呼吸（4-4-6），注意身體感受','列出 1 個念頭並標記：是事實還是解讀？']
 },
 blue:{
  kw:['穩定','釋放','界線'],
  actions:['寫下最困擾你的 1 件事，標註可控/不可控','做 60 秒身體放鬆（頸肩或腹部）','完成 1 件拖延小事並打勾']
 },
 orange:{
  kw:['流動','微調','韌性'],
  actions:['把卡點→調整 1 個微策略（A/B 測試）','25 分鐘番茄鐘全程專注','記錄 1 個有效回饋，明天沿用']
 },
 yellow:{
  kw:['決斷','意志','行動力'],
  actions:['把目標拆成 10 分鐘的一步，現在就做','設定今日 3 件 MIT','完成後回報給可信任對象']
 },
 green:{
  kw:['連結','共鳴','貢獻'],
  actions:['分享一個小成果到社群/朋友','邀請 1 人給具體回饋（3 句）','主動建立一個合作可能（發一則邀請）']
 },
 indigo:{
  kw:['直覺','洞見','願景'],
  actions:['寫 3 句「我允許…」對應今日焦點','回顧一次被支持的證據並記錄可複製點','今天主動請求一次幫助（小範圍）']
 },
 purple:{
  kw:['整合','結構化','長期化'],
  actions:['用 5 句話摘要本週 3 學到 + 1 改進','把有效步驟寫成 Checklist 並固定進行程','為下個週期設定一個可衡量指標（KPI）']
 }
};
const TRANSITIONS={
 'S1→S2':['把「我觀察到…」改寫成「我願意放下…」x3','情緒書寫→身體放鬆收尾（頸肩／腹部）'],
 'S2→S3':['列出 3 個現有資源（人/物/技能）','寫：若一切對我有利，今天我允許什麼？'],
 'S3→S4':['產出「最小可行步驟」並在 10 分鐘內啟動','預約 1 個「行動時段」，行前只做準備清單'],
 'S4→S5':['把今日回饋記錄並做一次微調','建立 25 分鐘專注儀式，結束回顧 2 分鐘'],
 'S5→S6':['公開分享一個進展並索取具體回饋','辨識最被共鳴的價值，明天主打該元素'],
 'S6→S7':['把有效做法寫成 SOP/Checklist','選一個可持續節奏（週/月）放進行事曆'],
 'S7→S1':['本週回顧 3 句＋下一輪新意圖 1 句','挑選 1 個欲精進的指標，設置觀測方式']
};

// Build questions UI
const qsDiv=document.getElementById('qs');
const sliders=[];
QUESTIONS.forEach((q,i)=>{
  const w=document.createElement('div');w.className='slider-wrap';
  const s=STAGES[q.stage]; 
  w.innerHTML=`<label class="q">${i+1}. <b>${s.zh}</b>｜<b>${s.name}</b>｜${q.text}</label>
  <input type="range" min="0" max="10" step="1" value="5" data-stage="${q.stage}"/>
  <div class="note">目前：<span class="cur">5</span> / 10</div>`;
  const range=w.querySelector('input'); const cur=w.querySelector('.cur');
  range.addEventListener('input',()=>cur.textContent=range.value);
  sliders.push(range); qsDiv.appendChild(w);
});

// Radar draw
const svg=document.getElementById('radar');
function polarToXY(cx,cy,r,angle){const rad=(angle-90)*Math.PI/180;return [cx+r*Math.cos(rad), cy+r*Math.sin(rad)];}
function drawRadar(values){ // values length 7 (0..10)
  const W=420,H=420,cx=W/2,cy=H/2,maxR=150,lvl=5;
  svg.innerHTML='';
  // grid
  for(let k=1;k<=lvl;k++){
    const r=maxR*k/lvl;
    let d='';
    for(let i=0;i<7;i++){
      const [x,y]=polarToXY(cx,cy,r,(360/7)*i);
      d+= (i===0?'M':'L')+x+','+y;
    }
    d+='Z';
    const p=document.createElementNS('http://www.w3.org/2000/svg','path');
    p.setAttribute('d',d); p.setAttribute('fill','none');
    p.setAttribute('stroke','#2c2146'); p.setAttribute('stroke-width','1');
    svg.appendChild(p);
  }
  // axes & labels
  for(let i=0;i<7;i++){
    const [x,y]=polarToXY(cx,cy,maxR,(360/7)*i);
    const line=document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1',cx); line.setAttribute('y1',cy);
    line.setAttribute('x2',x); line.setAttribute('y2',y);
    line.setAttribute('stroke','#2c2146'); svg.appendChild(line);
    const [lx,ly]=polarToXY(cx,cy,maxR+18,(360/7)*i);
    const t=document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x',lx); t.setAttribute('y',ly); t.setAttribute('text-anchor','middle'); t.setAttribute('class','axis-label');
    t.textContent=STAGES[i].zh+'｜'+STAGES[i].name;
    svg.appendChild(t);
  }
  // data polygon
  let d='';
  for(let i=0;i<7;i++){
    const r=maxR*(values[i]/10);
    const [x,y]=polarToXY(cx,cy,r,(360/7)*i);
    d+= (i===0?'M':'L')+x+','+y;
  }
  d+='Z';
  const poly=document.createElementNS('http://www.w3.org/2000/svg','path');
  poly.setAttribute('d',d);
  poly.setAttribute('fill','rgba(139,92,246,.35)');
  poly.setAttribute('stroke','#8b5cf6');
  poly.setAttribute('stroke-width','2');
  svg.appendChild(poly);
}
function getAverages(){
  const sums=[0,0,0,0,0,0,0], cnt=[0,0,0,0,0,0,0];
  sliders.forEach(r=>{const s=+r.dataset.stage; sums[s]+=+r.value; cnt[s]++;});
  return sums.map((v,i)=> Number((v/cnt[i]).toFixed(1)));
}

function minTwoIdx(arr){
  // return indices of two smallest elements
  let idx=[0,1,2,3,4,5,6].sort((a,b)=>arr[a]-arr[b]); return idx.slice(0,2);
}

function renderS7(values){
  const idx=minTwoIdx(values);
  const wrap=document.getElementById('s7'); wrap.innerHTML='';
  idx.forEach(i=>{
    const st=STAGES[i];
    const detail=S7_DETAIL[{0:'white',1:'blue',2:'orange',3:'yellow',4:'green',5:'indigo',6:'purple'}[i]];
    const card=document.createElement('div'); card.className='card';
    const score=values[i];
    card.innerHTML=`<div class="s7-item"><span class="kv">${st.zh}｜${st.name}</span><span class="kv">平均 ${score}</span></div>
      <div class="s7-item"><b>關鍵字</b>：${detail.kw.map(k=>`<span class="tag">${k}</span>`).join('')}</div>
      <div class="s7-item"><b>行動建議</b>：<ul class="actions">${detail.actions.map(a=>`<li>${a}</li>`).join('')}</ul></div>
      <hr class="sep"><div class="s7-item"><b>瓶頸轉換</b>：<div class="small">${transitionText(i)}</div></div>`;
    wrap.appendChild(card);
  });
}
function transitionText(i){
  const map=['S1→S2','S2→S3','S3→S4','S4→S5','S5→S6','S6→S7','S7→S1'];
  const key=map[i]; const tips=TRANSITIONS[key];
  return `<div class="s7-item"><div class="kv">${key}</div><ul class="actions">${tips.map(t=>`<li>${t}</li>`).join('')}</ul></div>`;
}

// Oracle (daily)
let ORACLES=[];
fetch('oracle_whispering.json').then(r=>r.json()).then(list=>{ORACLES=list; ensureOracleToday();});
function ensureOracleToday(){
  const box=document.getElementById('oracleBox');
  const key='oracleDate', keyIdx='oracleIdx';
  const today=new Date().toISOString().slice(0,10);
  let d=localStorage.getItem(key), idx=localStorage.getItem(keyIdx);
  if(d!==today || idx===null){
    idx=Math.floor(Math.random()*ORACLES.length);
    localStorage.setItem(key,today);
    localStorage.setItem(keyIdx,idx);
  }
  const o=ORACLES[+idx];
  box.innerHTML=`<div class="title">「${o.title}」</div><div>${o.text}</div><div class="small" style="margin-top:6px">行動：${o.action}</div>`;
}
document.getElementById('drawOracle').addEventListener('click',ensureOracleToday);

// Oils
let OILS=[];
fetch('yl_blends.json').then(r=>r.json()).then(list=>OILS=list);
function suggestOil(values){
  // pick by lowest stage -> choose from mapping
  const idx=minTwoIdx(values)[0];
  const map={
    0:['Peace & Calming','Clarity','Awaken'],
    1:['Release','Stress Away','AromaEase'],
    2:['En-R-G-E','Inspiration','Dream Catcher'],
    3:['Valor','Magnify Your Purpose','Acceptance'],
    4:['Harmony','Joy','Gratitude'],
    5:['Transformation','Into the Future','Envision'],
    6:['Present Time','Forgiveness','Sacred Mountain']
  };
  const pool=map[idx];
  const picks=pool.map(nm=>OILS.find(o=>o.name===nm)).filter(Boolean);
  return picks[Math.floor(Math.random()*picks.length)] || OILS[Math.floor(Math.random()*OILS.length)];
}
function renderOil(o){
  const box=document.getElementById('oilBox');
  if(!o){ box.textContent='資料尚未載入或尚未生成雷達圖。'; return; }
  box.innerHTML=`<div class="card"><b>${o.name}</b>（${o.zh_name}）<br>${o.description}</div>`;
}
document.getElementById('swapOil').addEventListener('click',()=>{
  const vals=getAverages(); renderOil(suggestOil(vals));
});

// Generate Radar & S7 & Oil
document.getElementById('genRadar').addEventListener('click',()=>{
  const vals=getAverages();
  drawRadar(vals); renderS7(vals); renderOil(suggestOil(vals));
});

// Progress + badges + hidden cards
const confetti=document.getElementById('confetti');
function celebrate(){
  // simple confetti
  confetti.innerHTML='';
  const colors=['#22d3ee','#34d399','#fde047','#fb7185','#a78bfa','#60a5fa'];
  for(let i=0;i<120;i++){
    const el=document.createElement('i');
    el.style.left=Math.random()*100+'%';
    el.style.background=colors[Math.floor(Math.random()*colors.length)];
    el.style.animationDelay=(Math.random()*600)+'ms';
    confetti.appendChild(el);
  }
  setTimeout(()=> confetti.innerHTML='',1800);
}
function loadProg(){ return JSON.parse(localStorage.getItem('e7_prog')||'{"p7":0,"p21":0,"p30":0,"cards":0,"last":""}');}
function saveProg(p){ localStorage.setItem('e7_prog',JSON.stringify(p));}
function renderProg(){
  const p=loadProg();
  const set=(id,val,den)=>{
    document.getElementById(id+'Txt').textContent=val;
    document.getElementById(id+'Bar').style.width=(100*Math.min(val,den)/den)+'%';
  };
  set('p7',p.p7,7); set('p21',p.p21,21); set('p30',p.p30,30);
  document.getElementById('checkinHint').textContent= p.last===todayStr()? '今天已打卡 ✅' : '尚未打卡';
}
function todayStr(){ return new Date().toISOString().slice(0,10);}
function unlockCard(){
  fetch('hidden_cards.json').then(r=>r.json()).then(cards=>{
    const p=loadProg(); const idx=p.cards % cards.length;
    const c=cards[idx];
    p.cards++; saveProg(p);
    const box=document.getElementById('hiddenCard');
    box.style.display='block'; box.innerHTML=`<b>新解鎖 #${p.cards}：</b> ${c.title}<hr class="sep"><div>${c.text}</div>`;
  });
}
document.getElementById('checkinBtn').addEventListener('click',()=>{
  const p=loadProg(); const t=todayStr();
  if(p.last===t){ alert('今天已打卡。'); return; }
  p.last=t; p.p7++; p.p21++; p.p30++;
  let unlocked=false;
  if(p.p7>=7){ p.p7=0; unlocked=true; celebrate(); document.getElementById('b7').textContent='7 日徽章 ✨'; }
  if(p.p21>=21){ p.p21=0; unlocked=true; celebrate(); document.getElementById('b21').textContent='21 日徽章 ✨'; }
  if(p.p30>=30){ p.p30=0; unlocked=true; celebrate(); document.getElementById('b30').textContent='30 日徽章 ✨（靈魂整合卡）'; }
  saveProg(p); renderProg();
  if(unlocked) unlockCard();
});
renderProg();

// PWA
if('serviceWorker' in navigator){ window.addEventListener('load',()=>navigator.serviceWorker.register('sw.js'));}
</script>
</body>
</html>
